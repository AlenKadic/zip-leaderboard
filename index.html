<!doctype html> 
<html>
<head>
  <meta charset="utf-8">
  <title>Zip Community Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSP: allow inline scripts so our page JS can run -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://accounts.google.com;
                 connect-src 'self' https://script.google.com https://script.googleusercontent.com https://oauth2.googleapis.com https://accounts.google.com;
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 frame-src https://accounts.google.com;">

  <!-- Google Sign-In -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{--card:#fff;--line:#eee;--muted:#666}
    body{font:16px system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;background:#fafafa}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
    .brand{font-size:32px;font-weight:800;line-height:1.15;}
    .btn{padding:8px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    h2,h3{margin:8px 0 12px}
    small{color:var(--muted)}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    /* (optional) you can delete the media query entirely */
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row-between{display:flex;justify-content:space-between;align-items:center;gap:12px}
    select{padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#fff}
    input{padding:8px 10px;border:1px solid #ddd;border-radius:8px}
    .hide{display:none}
    .right{margin-left:auto}
    .toast{font-size:14px}
    .namecell a{font-size:12px;margin-left:6px;text-decoration:none}
    .footer{margin-top:28px;color:var(--muted)}
    .footer small{font-size:13px}
    .footer a{color:inherit;text-decoration:underline}
    .muted{color:var(--muted)}
    .consent{display:flex;align-items:center;gap:10px;margin-right:16px}
    .consent a{text-decoration:underline}

    /* Make # and Time columns 60px in all tables */
    table { table-layout: fixed; }
      :is(#today,#avg,#mine) th, :is(#today,#avg,#mine) td {
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
      :is(#today,#avg,#mine) th:nth-child(1),
      :is(#today,#avg,#mine) td:nth-child(1) { width: 60px; }   /* # */
      :is(#today,#avg,#mine) th:nth-child(3),
      :is(#today,#avg,#mine) td:nth-child(3) { width: 120px; }   /* Time / Avg Time */

    /* --- NEW: prevent header overflow on mobile --- */
    html, body { overflow-x: hidden; }              /* stop any horizontal scroll */
    header > .row { flex: 1 1 640px; min-width: 0;} /* let the right block shrink instead of pushing */

    @media (max-width: 600px) {
      .brand { font-size: 26px; }
      .consent { width: 100%; margin-right: 0; }    /* consent on its own row */
      #authRow { width: 100%; gap: 8px; }           /* buttons on the next row */
      .g_id_signin {
        transform: scale(0.88);                     /* gently shrink Google button */
        transform-origin: left top;
      }
      #authRow .btn { flex: 0 0 auto; }             /* keep email button compact */
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      Zip Community Leaderboard
      <!-- subtitle: now NOT bold -->
      <div class="muted" style="font-size:14px;margin-top:2px;font-weight:normal;">
        <p style="margin:0">Unofficial, fan-created community leaderboard for the Zip puzzle.</p>
        <p style="margin:0">Not affiliated with or endorsed by LinkedIn.</p>
      </div>
    </div>

    <div class="row">
      <!-- Consent gate -->
      <label class="consent" title="Required to use the service">
        <input type="checkbox" id="accept">
        <span>To log in, I agree to the <a href="terms.html" target="_blank" rel="noopener">Terms</a> and acknowledge the <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.</span>
      </label>

      <!-- Auth (hidden until acceptance) -->
      <div id="authRow" class="row hide">
        <div id="g_id_onload"
          data-client_id="368132008439-lskm63n5dmsv9r43cchmrjpdmhfqaa1p.apps.googleusercontent.com"
          data-callback="onGoogle"
          data-auto_select="false"
          data-auto_prompt="false"
          data-itp_support="true"></div>
        <div class="g_id_signin" data-type="standard" data-size="medium"></div>

        <span class="btn" id="useEmail">Use email instead</span>
        <button class="btn hide" id="signOut">Sign out</button>
      </div>
    </div>
  </header>

  <div class="card">
    <h2>Public Leaderboards</h2>
    <small>Visible to everyone. Only <em>Name</em> + time are shown (with a LinkedIn link if you added one).</small>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row-between">
        <h3 id="todayTitle">Puzzle #</h3>
        <div class="row">
          <select id="puzzleSel" title="Choose a day/puzzle"></select>
          <button class="btn" id="refresh" title="Reload data">Reload</button>
        </div>
      </div>
      <table id="today"><thead><tr><th>#</th><th>Player</th><th>Time</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Average time (per person)</h3>
      <table id="avg"><thead><tr><th>#</th><th>Player</th><th>Avg Time</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card">
    <h2>My private profile</h2>
    <small>Only you can see and edit this after signing in.</small>

    <!-- Email OTP box -->
    <div id="emailBox" class="hide" style="margin:12px 0 4px">
      <div class="row">
        <label>Email <input id="eml" placeholder="you@example.com"></label>
        <button class="btn" id="sendCode">Get code</button>
        <label>Code <input id="otp" placeholder="6-digit"></label>
        <button class="btn" id="verifyCode">Verify</button>
        <span class="toast" id="otpMsg"></span>
      </div>
      <small class="muted">We’ll send a one-time code only to sign you in. No marketing. The code expires in 10 minutes.</small>
      <div style="height:1px;background:#eee;margin:12px 0"></div>
    </div>

    <!-- Private area -->
    <div id="private" class="hide">
      <div class="row" style="margin-top:10px">
        <label>Name
          <input id="name" maxlength="80" placeholder="Shown on leaderboards">
        </label>
        <label>LinkedIn URL (optional)
          <input id="li" maxlength="200" placeholder="https://www.linkedin.com/in/…">
        </label>
        <button class="btn" id="saveProfile">Save</button>
        <span class="toast" id="nameMsg"></span>
      </div>

      <div class="row" style="margin-top:10px">
        <label>Puzzle # <input id="pNum" type="number" min="1" placeholder="e.g., 193"></label>
        <label>Time (mm:ss) <input id="pTime" placeholder="0:08" pattern="\\d{1,2}:[0-5]\\d"></label>
        <button class="btn" id="submitScore">Submit</button>
        <span class="toast" id="msg"></span>
        <button class="btn right" id="deleteMe" title="Delete profile & all scores">Delete my data</button>
      </div>

      <h3 style="margin-top:16px">My best scores</h3>
      <table id="mine"><thead><tr><th>#</th><th>Puzzle</th><th>Time</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- Shown when signed out -->
    <div id="pleaseSignIn">
      <small>Sign in above to manage your private profile and submit scores.</small>
      <div class="muted" style="margin-top:6px">
        <small>
          By signing in you agree to our
          <a href="terms.html" target="_blank" rel="noopener">Terms</a> and
          <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.
        </small>
      </div>
    </div>
  </div>

<script>
const APPS = 'https://script.google.com/macros/s/AKfycbxNN6VLQeEkC0oA6AXbx1jO9XWPT-NBv99_UEvzdkGrSAbHwizBm-j7WVhlTWI1w8gy/exec';

let provider = localStorage.getItem('zip_provider') || null;
let idToken = localStorage.getItem('zip_idtoken') || null;
let sessionToken = localStorage.getItem('zip_session') || null;

/* ---------- consent gate ---------- */
function isAccepted(){ return localStorage.getItem('zip_accept') === '1'; }
function setGate(on){
  document.getElementById('authRow').classList.toggle('hide', !on);
}
(function initConsent(){
  const box = document.getElementById('accept');
  const accepted = isAccepted();
  box.checked = accepted;
  setGate(accepted);
  box.addEventListener('change', (e)=>{
    const ok = !!e.target.checked;
    localStorage.setItem('zip_accept', ok ? '1' : '0');
    setGate(ok);
  });
})();

/* ---------- UI helpers ---------- */
function showPrivate(on){
  document.getElementById('private').classList.toggle('hide', !on);
  document.getElementById('pleaseSignIn').classList.toggle('hide', on);
  document.getElementById('signOut').classList.toggle('hide', !on);
}
function linkHtml(url){ return url ? `<a href="${url}" target="_blank" rel="noopener" title="LinkedIn">↗</a>` : ''; }
function renderRows(id, rows){
  const tb = document.querySelector('#'+id+' tbody'); tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td class="namecell">${r.player || ''}${linkHtml(r.linkedin)}</td><td>${r.time || ''}</td>`;
    tb.appendChild(tr);
  });
}
function setTodayTitle(_puzzle, label){
  document.getElementById('todayTitle').textContent = label || 'Puzzle #';
}

/* ---------- puzzles dropdown ---------- */
function populatePuzzles(list, latest){
  const sel = document.getElementById('puzzleSel');
  sel.innerHTML = '';
  (list||[]).sort((a,b)=> b.puzzle - a.puzzle).forEach(it=>{
    const opt = document.createElement('option');
    opt.value = it.puzzle;
    opt.textContent = `${it.date} — #${it.puzzle}`;
    if (String(it.puzzle) === String(latest)) opt.selected = true;
    sel.appendChild(opt);
  });
  const label = sel.selectedOptions[0] ? sel.selectedOptions[0].textContent : ('Puzzle #'+(latest||''));
  setTodayTitle(sel.value || latest, label);
}

/* ---------- Public boards ---------- */
async function loadBoards(puzzle){
  try{
    const q = puzzle ? ('&puzzle='+encodeURIComponent(puzzle)) : '';
    const r = await fetch(APPS+'?action=leaderboard'+q);
    const j = await r.json();

    if (j.puzzles) populatePuzzles(j.puzzles, puzzle || j.latestPuzzle);
    renderRows('today', j.today||[]);
    renderRows('avg',   j.averages||[]);

    if (j.latestPuzzle && !document.getElementById('pNum').value) {
      document.getElementById('pNum').value = j.latestPuzzle;
    }
  }catch(e){ console.error(e); }
}
document.getElementById('puzzleSel').addEventListener('change', (e)=>{
  const opt = e.target.selectedOptions[0];
  setTodayTitle(e.target.value, opt ? opt.textContent : '');
  loadBoards(e.target.value);
});
document.getElementById('refresh').onclick = ()=>{
  const v = document.getElementById('puzzleSel').value;
  loadBoards(v);
};

/* ---------- Auth ---------- */
document.getElementById('useEmail').onclick = ()=>{
  if (!isAccepted()){ alert('Please accept the Terms and Privacy Policy first.'); return; }
  document.getElementById('emailBox').classList.remove('hide');
};

document.getElementById('signOut').onclick = async ()=>{
  try{
    if (provider==='email' && sessionToken){
      await fetch(APPS+'?action=logout', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'logout', sessionToken})
      });
    }
  }catch(_){}
  localStorage.removeItem('zip_idtoken'); localStorage.removeItem('zip_session'); localStorage.removeItem('zip_provider');
  provider = idToken = sessionToken = null;
  showPrivate(false);
};

/* Google One Tap callback */
window.onGoogle = (resp) => {
  if (!isAccepted()){ alert('Please accept the Terms and Privacy Policy first.'); return; }
  idToken = resp.credential;
  provider = 'google';
  localStorage.setItem('zip_idtoken', idToken);
  localStorage.setItem('zip_provider', provider);
  initMe();
};

/* Email OTP */
document.getElementById('sendCode').onclick = async ()=>{
  if (!isAccepted()){ alert('Please accept the Terms and Privacy Policy first.'); return; }
  const email = document.getElementById('eml').value.trim();
  const msg = document.getElementById('otpMsg'); msg.textContent = 'Sending...';
  try{
    const r = await fetch(APPS+'?action=requestOtp', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'requestOtp', email}) });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Failed');
    msg.textContent = 'Code sent. Check your inbox (valid 10 min).';
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

document.getElementById('verifyCode').onclick = async ()=>{
  if (!isAccepted()){ alert('Please accept the Terms and Privacy Policy first.'); return; }
  const email = document.getElementById('eml').value.trim();
  const code = document.getElementById('otp').value.trim();
  const msg = document.getElementById('otpMsg'); msg.textContent = 'Verifying...';
  try{
    const r = await fetch(APPS+'?action=verifyOtp', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action:'verifyOtp', email, code}) });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Failed');
    sessionToken = j.sessionToken; provider='email';
    localStorage.setItem('zip_session', sessionToken);
    localStorage.setItem('zip_provider', provider);
    msg.textContent = 'Signed in ✔';
    initMe();
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

/* ---------- Private area ---------- */
async function initMe(){
  if (provider==='google' && idToken){
    const r = await fetch(APPS+'?action=me&idToken='+encodeURIComponent(idToken));
    const j = await r.json();
    if (j.error){ showPrivate(false); return; }
    showPrivate(true);
    document.getElementById('name').value = (j.profile && j.profile.name) || 'Player';
    document.getElementById('li').value = (j.profile && j.profile.linkedin) || '';
    const mine = (j.scores||[]).sort((a,b)=>a.seconds-b.seconds);
    const tb = document.querySelector('#mine tbody'); tb.innerHTML='';
    mine.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.puzzle}</td><td>${r.time}</td>`;
      tb.appendChild(tr);
    });
    return;
  }
  if (provider==='email' && sessionToken){
    const r = await fetch(APPS+'?action=me&sessionToken='+encodeURIComponent(sessionToken));
    const j = await r.json();
    if (j.error){ showPrivate(false); return; }
    showPrivate(true);
    document.getElementById('name').value = (j.profile && j.profile.name) || 'Player';
    document.getElementById('li').value = (j.profile && j.profile.linkedin) || '';
    const mine = (j.scores||[]).sort((a,b)=>a.seconds-b.seconds);
    const tb = document.querySelector('#mine tbody'); tb.innerHTML='';
    mine.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.puzzle}</td><td>${r.time}</td>`;
      tb.appendChild(tr);
    });
    return;
  }
  showPrivate(false);
}

/* ---------- boot ---------- */
loadBoards();
if (provider) initMe();
</script>

<footer class="footer">
  <p class="muted" style="margin-top:8px">
    “Zip” and “LinkedIn” are trademarks of LinkedIn Corporation. This is an independent community project and is not affiliated with, endorsed by, or sponsored by LinkedIn.
  </p>
</footer>
</body>
</html>

