<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Zip Community Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSP (add your Apps Script domain if different) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://accounts.google.com;
                 connect-src 'self' https://script.google.com https://script.googleusercontent.com https://oauth2.googleapis.com https://accounts.google.com;
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 frame-src https://accounts.google.com;">

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg:#fafafa; --card:#fff; --line:#eee; --muted:#666; --ink:#111;
      --accent:#4f46e5; --accent-ink:#fff; --good:#16a34a; --bad:#dc2626
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font:16px system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between;z-index:10}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .brand h1{font-size:22px;margin:0}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .auth{display:flex;align-items:center;gap:10px}
    .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
    main{max-width:980px;margin:20px auto;padding:0 16px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 260px}
    .controls .pill{display:inline-flex;gap:8px;border:1px solid var(--line);border-radius:999px;padding:4px;background:#f5f5f5}
    .controls button{border:0;background:transparent;padding:6px 10px;border-radius:999px;cursor:pointer;color:var(--muted)}
    .controls button.active{background:var(--card);color:var(--ink);border:1px solid var(--line)}
    .search{display:flex;gap:8px}
    input[type="text"], input[type="number"]{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;outline:none
    }
    input[type="number"]{max-width:140px}
    .btn{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:var(--accent-ink)}
    .btn.warn{border-color:#f3dada;background:#fff;color:var(--bad)}
    .btn.icon{padding:6px 9px;display:inline-flex;align-items:center;gap:6px}
    .btn.sm{padding:4px 8px;font-size:13px;border-radius:8px}
    .right{margin-left:auto}
    h2{font-size:18px;margin:0 0 10px}
    .hint{font-size:13px;color:var(--muted);margin:0 0 8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-top:1px solid var(--line);text-align:left}
    thead th{font-weight:600;color:#333;background:#faf7ff}
    tbody tr:hover{background:#fafafa}
    .num{width:48px;text-align:right}
    .w150{width:150px}
    .mono{font-variant-numeric:tabular-nums}
    .section{background:#f5f0ff;border:1px solid #eee;border-radius:12px;padding:12px 12px 4px;margin-bottom:16px}
    .section > h3{margin:4px 8px 8px;font-size:16px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .good{color:var(--good)}
    .muted{color:var(--muted)}
    .my{margin:12px 0}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">
        <div class="dot"></div>
        <h1>Zip Community Leaderboard</h1>
      </div>
      <div class="sub">Unofficial, fan-created community leaderboard for the Zip puzzle. Not affiliated with or endorsed by LinkedIn.</div>
    </div>
    <div class="auth">
      <div id="gsi" style="display:none"></div>
      <img id="avatar" class="avatar" alt="" src="" style="display:none">
      <button id="signout" class="btn" style="display:none">Sign out</button>
    </div>
  </header>

  <main>
    <div class="section">
      <h3>Public Leaderboards</h3>
      <p class="hint">Visible to everyone. Only <em>Name</em> + time are shown (with a LinkedIn link if you added one).</p>
    </div>

    <!-- Daily leaderboard -->
    <section class="panel my">
      <div class="flex">
        <h2 id="dayTitle">â€”</h2>
        <span class="spacer"></span>
        <select id="puzzleSelect" class="btn"></select>
        <button id="reloadDaily" class="btn icon"><span>Reload</span></button>
      </div>
      <table id="dailyTable">
        <thead>
          <tr>
            <th class="num">#</th>
            <th>Player</th>
            <th class="mono">Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Averages -->
    <section class="panel my">
      <div class="flex">
        <h2>Average time (per person)</h2>
      </div>
      <table id="avgTable">
        <thead>
          <tr>
            <th class="num">#</th>
            <th>Player</th>
            <th class="mono">Avg Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Private area -->
    <section class="panel my" id="privateArea" style="background:#eaf7ef;border-color:#d2e9d9">
      <h2>My private profile</h2>
      <p class="hint">Only you can see and edit this after signing in.</p>

      <!-- PERSONAL INFO ROW + Delete my data moved here -->
      <div class="row" style="align-items:flex-end;margin-bottom:10px">
        <div class="grow">
          <label class="hint">Name</label>
          <input id="nameInput" type="text" placeholder="Your name">
        </div>
        <div class="grow">
          <label class="hint">LinkedIn URL (optional)</label>
          <input id="liInput" type="text" placeholder="https://www.linkedin.com/in/...">
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="saveProfile" class="btn primary">Save</button>
          <span id="saveProfileState" class="muted"></span>
          <!-- DELETE MY DATA is now in this first row -->
          <button id="deleteAll" class="btn warn">Delete my data</button>
        </div>
      </div>

      <!-- SUBMIT TIME -->
      <div class="row" style="align-items:flex-end">
        <div>
          <label class="hint">Puzzle #</label>
          <input id="puzzleInput" type="number" min="1" placeholder="e.g., 194">
        </div>
        <div>
          <label class="hint">Time (mm:ss)</label>
          <input id="timeInput" type="text" placeholder="e.g., 03:12">
        </div>
        <div>
          <button id="submitTime" class="btn">Submit</button>
          <span id="submitState" class="muted"></span>
        </div>
      </div>

      <!-- MY BEST SCORES -->
      <h3 class="my" style="margin-top:16px">My best scores</h3>
      <table id="mineTable">
        <thead>
          <tr>
            <th class="num">#</th>
            <th>Puzzle</th>
            <th class="w150">Date and Time</th>
            <th class="mono">Time</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    /**********************
     * CONFIG
     **********************/
    const GOOGLE_CLIENT_ID = "YOUR_GOOGLE_OAUTH_CLIENT_ID"; // set this
    const CLOUD_ENDPOINT   = ""; // Apps Script WebApp URL (leave empty for Local Demo Mode)

    /**********************
     * UTIL
     **********************/
    const $ = sel => document.querySelector(sel);
    const fmtMMSS = s => {
      if (isNaN(s) || s < 0) return "";
      const m = Math.floor(s/60), ss = Math.floor(s%60);
      return `${String(m).padStart(1,'0')}:${String(ss).padStart(2,'0')}`;
    };
    const parseMMSS = (txt) => {
      const m = /^(\d{1,3}):([0-5]\d)$/.exec((txt||"").trim());
      if (!m) return NaN;
      return (+m[1])*60 + (+m[2]);
    };
    const fmtDateTime = (t) => {
      const d = new Date(t);
      const y = d.getFullYear(), M = String(d.getMonth()+1).padStart(2,'0'), D = String(d.getDate()).padStart(2,'0');
      const h = String(d.getHours()).padStart(2,'0'), m = String(d.getMinutes()).padStart(2,'0');
      return `${y}-${M}-${D} ${h}:${m}`;
    };
    const uid = () => 'r_'+Math.random().toString(36).slice(2)+Date.now();

    /**********************
     * AUTH (GSI or Demo)
     **********************/
    let currentUser = null; // {uid, name, picture, email?}

    function setSignedInUI() {
      if (currentUser) {
        $('#avatar').src = currentUser.picture || '';
        $('#avatar').style.display = currentUser.picture ? 'inline-block' : 'none';
        $('#signout').style.display = 'inline-block';
        $('#gsi').style.display = 'none';
        $('#privateArea').style.display = 'block';
      } else {
        $('#avatar').style.display = 'none';
        $('#signout').style.display = 'none';
        $('#gsi').style.display = 'block';
        $('#privateArea').style.display = 'none';
      }
    }

    function initAuth() {
      if (!GOOGLE_CLIENT_ID) {
        // Demo fallback
        currentUser = { uid: 'demo-user', name: 'Demo User', picture: '' };
        setSignedInUI();
        loadAll();
        return;
      }
      window.google?.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse
      });
      window.google?.accounts.id.renderButton(
        document.getElementById("gsi"),
        { theme: "outline", size: "medium" }
      );
      document.getElementById('signout').onclick = () => {
        window.google?.accounts.id.disableAutoSelect();
        currentUser = null;
        setSignedInUI();
        clearTables();
      };
    }

    function handleCredentialResponse(resp){
      // decode JWT (client-side) for profile (non-secure, good enough for UI)
      const payload = JSON.parse(atob(resp.credential.split('.')[1]));
      currentUser = {
        uid: payload.sub,
        name: payload.name,
        picture: payload.picture,
        email: payload.email
      };
      setSignedInUI();
      loadAll();
    }

    /**********************
     * STORAGE / API
     * If CLOUD_ENDPOINT empty => use localStorage
     **********************/
    const LS_PROFILE = 'zip_profile';
    const LS_RESULTS = 'zip_results';

    async function api(action, data) {
      if (!CLOUD_ENDPOINT) return localApi(action, data);
      const res = await fetch(CLOUD_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action, data})
      });
      if (!res.ok) throw new Error('Network');
      return res.json();
    }

    // Local demo implementation
    function getAllLS(key){ return JSON.parse(localStorage.getItem(key) || '[]'); }
    function setAllLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    async function localApi(action, data){
      let profiles = JSON.parse(localStorage.getItem(LS_PROFILE)||'{}'); // map uid -> {name,linkedin}
      let results  = getAllLS(LS_RESULTS); // array

      if (action==='getBootstrap'){
        return {
          profile: profiles[currentUser?.uid] || null,
          resultsAll: results
        };
      }
      if (action==='saveProfile'){
        profiles[currentUser.uid] = { name:data.name||'', linkedin:data.linkedin||'' };
        localStorage.setItem(LS_PROFILE, JSON.stringify(profiles));
        return {ok:true};
      }
      if (action==='submitTime'){
        const rec = {
          id: uid(),
          uid: currentUser.uid,
          name: (profiles[currentUser.uid]?.name) || currentUser.name || 'Anonymous',
          linkedin: profiles[currentUser.uid]?.linkedin || '',
          puzzle: +data.puzzle,
          seconds: +data.seconds,
          ts: Date.now()
        };
        results.push(rec);
        setAllLS(LS_RESULTS, results);
        return {ok:true, rec};
      }
      if (action==='deleteAll'){
        delete profiles[currentUser.uid];
        results = results.filter(r => r.uid !== currentUser.uid);
        localStorage.setItem(LS_PROFILE, JSON.stringify(profiles));
        setAllLS(LS_RESULTS, results);
        return {ok:true};
      }
      if (action==='deleteResult'){
        results = results.filter(r => r.id !== data.id || r.uid !== currentUser.uid ? true : false)
                         .filter(r => !(r.id===data.id && r.uid===currentUser.uid) ? true : false);
        // simpler: keep if not both match
        results = getAllLS(LS_RESULTS).filter(r => !(r.id===data.id && r.uid===currentUser.uid));
        setAllLS(LS_RESULTS, results);
        return {ok:true};
      }
      if (action==='listResults'){ return {results}; }
      return {ok:false};
    }

    /**********************
     * RENDER
     **********************/
    let ALL_RESULTS = []; // all users (for public boards)
    let MY_PROFILE = null;

    function clearTables(){
      $('#dailyTable tbody').innerHTML = '';
      $('#avgTable tbody').innerHTML = '';
      $('#mineTable tbody').innerHTML = '';
    }

    function renderDaily(puzzleNum){
      const day = puzzleNum;
      $('#dayTitle').textContent = `${new Date().toISOString().slice(0,10)} â€” #${day}`;
      const rows = ALL_RESULTS
        .filter(r => r.puzzle === +puzzleNum)
        .sort((a,b)=>a.seconds-b.seconds);
      const tb = $('#dailyTable tbody');
      tb.innerHTML = rows.map((r,i)=>`
        <tr>
          <td class="num">${i+1}</td>
          <td>${linkName(r)}</td>
          <td class="mono">${fmtMMSS(r.seconds)}</td>
        </tr>
      `).join('') || `<tr><td colspan="3" class="muted">No results yet.</td></tr>`;
    }

    function renderAverages(){
      const map = new Map(); // uid -> {name,linkedin,sum,count}
      for (const r of ALL_RESULTS){
        if (!map.has(r.uid)) map.set(r.uid, {name:r.name, linkedin:r.linkedin, sum:0, count:0});
        const m = map.get(r.uid); m.sum += r.seconds; m.count += 1;
      }
      const rows = Array.from(map.values())
        .map(v => ({...v, avg: v.sum / v.count}))
        .sort((a,b)=>a.avg-b.avg);
      const tb = $('#avgTable tbody');
      tb.innerHTML = rows.map((r,i)=>`
        <tr>
          <td class="num">${i+1}</td>
          <td>${linkName(r)}</td>
          <td class="mono">${fmtMMSS(r.avg)}</td>
        </tr>
      `).join('') || `<tr><td colspan="3" class="muted">No results yet.</td></tr>`;
    }

    function linkName(obj){
      const name = escapeHtml(obj.name || 'Anonymous');
      const li = (obj.linkedin||'').trim();
      if (li) return `<a href="${encodeURI(li)}" target="_blank" rel="noopener">${name}</a>`;
      return name;
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function renderMine(){
      const mine = ALL_RESULTS
        .filter(r => r.uid === currentUser?.uid)
        .sort((a,b)=>a.seconds-b.seconds || b.ts-a.ts);

      const tb = $('#mineTable tbody');
      tb.innerHTML = mine.map((r,i)=>`
        <tr data-id="${r.id}">
          <td class="num">${i+1}</td>
          <td>#${r.puzzle}</td>
          <td>${fmtDateTime(r.ts)}</td>
          <td class="mono">${fmtMMSS(r.seconds)}</td>
          <td><button class="btn sm icon warn delOne" data-id="${r.id}" title="Delete this result">ðŸ—‘ Delete</button></td>
        </tr>
      `).join('') || `<tr><td colspan="5" class="muted">No results yet â€” submit your first!</td></tr>`;

      // hook delete buttons
      tb.querySelectorAll('.delOne').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          if (!confirm('Delete this result?')) return;
          await api('deleteResult', {id});
          await bootstrap(); // reload data
        });
      });
    }

    /**********************
     * LOAD / BOOTSTRAP
     **********************/
    async function bootstrap(){
      if (!currentUser) return;
      const res = await api('getBootstrap', {});
      MY_PROFILE = res.profile || null;
      ALL_RESULTS = res.resultsAll || [];
      // fill profile inputs
      $('#nameInput').value = MY_PROFILE?.name || currentUser.name || '';
      $('#liInput').value   = MY_PROFILE?.linkedin || '';

      // puzzle selector (collect distinct)
      const puzzles = Array.from(new Set(ALL_RESULTS.map(r=>r.puzzle))).sort((a,b)=>a-b);
      const sel = $('#puzzleSelect');
      sel.innerHTML = (puzzles.length? puzzles : [194]).map(p=>`<option value="${p}">${new Date().toISOString().slice(0,10)} â€” #${p}</option>`).join('');
      renderDaily(sel.value);
      renderAverages();
      renderMine();
    }

    function loadAll(){ bootstrap(); }

    /**********************
     * EVENTS
     **********************/
    window.addEventListener('DOMContentLoaded', ()=>{
      initAuth();

      $('#saveProfile')?.addEventListener('click', async ()=>{
        const name = $('#nameInput').value.trim();
        const linkedin = $('#liInput').value.trim();
        await api('saveProfile', {name, linkedin});
        $('#saveProfileState').textContent = 'Saved âœ“';
        setTimeout(()=>$('#saveProfileState').textContent='', 1500);
        await bootstrap();
      });

      $('#submitTime')?.addEventListener('click', async ()=>{
        const puzzle = +$('#puzzleInput').value;
        const seconds = parseMMSS($('#timeInput').value);
        if (!puzzle || isNaN(seconds)) { $('#submitState').textContent = 'Enter valid puzzle and mm:ss time'; return; }
        $('#submitState').textContent = 'Savingâ€¦';
        await api('submitTime', {puzzle, seconds});
        $('#submitState').textContent = 'Saved âœ“';
        setTimeout(()=>$('#submitState').textContent='', 1500);
        $('#timeInput').value = '';
        await bootstrap();
      });

      $('#deleteAll')?.addEventListener('click', async ()=>{
        if (!confirm('Delete ALL your profile and results? This cannot be undone.')) return;
        await api('deleteAll', {});
        await bootstrap();
      });

      $('#puzzleSelect')?.addEventListener('change', e=>{
        renderDaily(e.target.value);
      });
      $('#reloadDaily')?.addEventListener('click', ()=> renderDaily($('#puzzleSelect').value));
    });
  </script>
</body>
</html>

