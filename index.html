<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Zip Community Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Google Sign-In -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{--card:#fff;--line:#eee;--muted:#666}
    body{font:16px system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;background:#fafafa}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
    .btn{padding:8px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    h2,h3{margin:8px 0 12px}
    small{color:var(--muted)}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{display:flex;flex-direction:column;font-size:14px;gap:6px}
    input{padding:8px 10px;border:1px solid #ddd;border-radius:8px}
    .hide{display:none}
    .right{margin-left:auto}
    .toast{font-size:14px}
    .namecell a{font-size:12px;margin-left:6px;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <div>
      <strong>Zip Community Leaderboard</strong>
      <small id="lp"></small>
    </div>

    <div id="authRow" class="row">
      <!-- Google One Tap -->
      <div id="g_id_onload"
        data-client_id="368132008439-lskm63n5dmsv9r43cchmrjpdmhfqaa1p.apps.googleusercontent.com"
        data-callback="onGoogle"
        data-auto_select="true"
        data-itp_support="true"></div>
      <div class="g_id_signin" data-type="standard" data-size="medium"></div>

      <!-- Email fallback -->
      <span class="btn" id="useEmail">Use email instead</span>
      <button class="btn hide" id="signOut">Sign out</button>
    </div>
  </header>

  <div class="card">
    <h2>Public Leaderboards</h2>
    <small>Visible to everyone. Only <em>Name</em> + time are shown (with a LinkedIn link if you added one).</small>
    <div class="row" style="margin-top:10px">
      <label>Puzzle #
        <input id="puzzle" type="number" min="1" placeholder="e.g., 193">
      </label>
      <button class="btn" id="reload">Reload</button>
      <span class="toast" id="status"></span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Today</h3>
      <table id="today"><thead><tr><th>#</th><th>Player</th><th>Time</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>All-time PBs</h3>
      <table id="all"><thead><tr><th>#</th><th>Player</th><th>Best</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card">
    <h2>My private profile</h2>
    <small>Only you can see and edit this after signing in.</small>

    <!-- Email OTP box -->
    <div id="emailBox" class="hide" style="margin:12px 0 4px">
      <div class="row">
        <label>Email <input id="eml" placeholder="you@example.com"></label>
        <button class="btn" id="sendCode">Get code</button>
        <label>Code <input id="otp" placeholder="6-digit"></label>
        <button class="btn" id="verifyCode">Verify</button>
        <span class="toast" id="otpMsg"></span>
      </div>
      <div style="height:1px;background:#eee;margin:12px 0"></div>
    </div>

    <!-- Private area -->
    <div id="private" class="hide">
      <div class="row" style="margin-top:10px">
        <label>Name
          <input id="name" maxlength="80" placeholder="Shown on leaderboards">
        </label>
        <label>LinkedIn URL (optional)
          <input id="li" maxlength="200" placeholder="https://www.linkedin.com/in/…">
        </label>
        <button class="btn" id="saveProfile">Save</button>
        <span class="toast" id="nameMsg"></span>
      </div>

      <div class="row" style="margin-top:10px">
        <label>Puzzle # <input id="pNum" type="number" min="1" placeholder="e.g., 193"></label>
        <label>Time (mm:ss) <input id="pTime" placeholder="0:08" pattern="\\d{1,2}:[0-5]\\d"></label>
        <button class="btn" id="submitScore">Submit</button>
        <span class="toast" id="msg"></span>
        <button class="btn right" id="deleteMe" title="Delete profile & all scores">Delete my data</button>
      </div>

      <h3 style="margin-top:16px">My best scores</h3>
      <table id="mine"><thead><tr><th>#</th><th>Puzzle</th><th>Time</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="pleaseSignIn"><small>Sign in above to manage your private profile and submit scores.</small></div>
  </div>

<script>
const APPS = 'https://script.google.com/macros/s/AKfycbxBj9_J3xh_NGmjRxm2Pq9mHJoeQ8bl_blD3Y4wBvlgTOZ2r9eIQR6FyYFMZ2tZ14VDTQ/exec';

let provider = localStorage.getItem('zip_provider') || null; // "google" | "email" | null
let idToken = localStorage.getItem('zip_idtoken') || null;   // Google ID token
let sessionToken = localStorage.getItem('zip_session') || null; // Email session token

/* ---------- UI helpers ---------- */
function showPrivate(on){
  document.getElementById('private').classList.toggle('hide', !on);
  document.getElementById('pleaseSignIn').classList.toggle('hide', on);
  document.getElementById('signOut').classList.toggle('hide', !on);
}
function setLatestPuzzle(n){ document.getElementById('lp').textContent = n ? '• latest puzzle #'+n : ''; }
function linkHtml(url){ return url ? `<a href="${url}" target="_blank" rel="noopener" title="LinkedIn">↗</a>` : ''; }
function renderRows(id, rows, cols){
  const tb = document.querySelector('#'+id+' tbody'); tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    const cells = cols.map(k => r[k]);
    // Special: name + optional LinkedIn
    if (id==='today' || id==='all'){
      tr.innerHTML = `<td>${i+1}</td><td class="namecell">${r.player || ''}${linkHtml(r.linkedin)}</td><td>${r.time || ''}</td>`;
    }else{
      tr.innerHTML = `<td>${i+1}</td>` + cols.map(k=>`<td>${r[k]}</td>`).join('');
    }
    tb.appendChild(tr);
  });
}

/* ---------- Public boards ---------- */
async function loadBoards(){
  const status = document.getElementById('status');
  status.textContent = 'Loading...';
  try{
    const p = document.getElementById('puzzle').value.trim();
    const r = await fetch(APPS+'?action=leaderboard'+(p?('&puzzle='+encodeURIComponent(p)):''));
    const j = await r.json();
    setLatestPuzzle(j.latestPuzzle);
    renderRows('today', j.today||[], ['player','time','linkedin']);
    renderRows('all', j.alltime||[], ['player','time','linkedin']);
    status.textContent = '';
    if (j.latestPuzzle && !document.getElementById('pNum').value) document.getElementById('pNum').value = j.latestPuzzle;
  }catch(e){ status.textContent = 'Error: '+e.message; }
}
document.getElementById('reload').onclick = loadBoards;

/* ---------- Auth ---------- */
document.getElementById('useEmail').onclick = ()=> document.getElementById('emailBox').classList.remove('hide');

document.getElementById('signOut').onclick = async ()=>{
  try{
    if (provider==='email' && sessionToken){
      await fetch(APPS+'?action=logout', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'logout', sessionToken})
      });
    }
  }catch(_){}
  localStorage.removeItem('zip_idtoken'); localStorage.removeItem('zip_session'); localStorage.removeItem('zip_provider');
  provider = idToken = sessionToken = null;
  showPrivate(false);
};

/* Google One Tap callback */
window.onGoogle = (resp) => {
  idToken = resp.credential;
  provider = 'google';
  localStorage.setItem('zip_idtoken', idToken);
  localStorage.setItem('zip_provider', provider);
  initMe(); // loads private area
};

/* Email OTP */
document.getElementById('sendCode').onclick = async ()=>{
  const email = document.getElementById('eml').value.trim();
  const msg = document.getElementById('otpMsg'); msg.textContent = 'Sending...';
  try{
    const r = await fetch(APPS+'?action=requestOtp', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'requestOtp', email})
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Failed');
    msg.textContent = 'Code sent. Check your inbox (valid 10 min).';
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

document.getElementById('verifyCode').onclick = async ()=>{
  const email = document.getElementById('eml').value.trim();
  const code = document.getElementById('otp').value.trim();
  const msg = document.getElementById('otpMsg'); msg.textContent = 'Verifying...';
  try{
    const r = await fetch(APPS+'?action=verifyOtp', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({action:'verifyOtp', email, code})
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Failed');
    sessionToken = j.sessionToken; provider='email';
    localStorage.setItem('zip_session', sessionToken);
    localStorage.setItem('zip_provider', provider);
    msg.textContent = 'Signed in ✔';
    initMe();
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

/* ---------- Private area ---------- */
async function initMe(){
  // For /me, send token via query (Apps Script reads query on GET)
  if (provider==='google' && idToken){
    const r = await fetch(APPS+'?action=me&idToken='+encodeURIComponent(idToken));
    const j = await r.json();
    if (j.error){ showPrivate(false); return; }
    showPrivate(true);
    document.getElementById('name').value = (j.profile && j.profile.name) || 'Player';
    document.getElementById('li').value = (j.profile && j.profile.linkedin) || '';
    const mine = (j.scores||[]).sort((a,b)=>a.seconds-b.seconds);
    renderRows('mine', mine, ['puzzle','time']);
    return;
  }
  if (provider==='email' && sessionToken){
    const r = await fetch(APPS+'?action=me&sessionToken='+encodeURIComponent(sessionToken));
    const j = await r.json();
    if (j.error){ showPrivate(false); return; }
    showPrivate(true);
    document.getElementById('name').value = (j.profile && j.profile.name) || 'Player';
    document.getElementById('li').value = (j.profile && j.profile.linkedin) || '';
    const mine = (j.scores||[]).sort((a,b)=>a.seconds-b.seconds);
    renderRows('mine', mine, ['puzzle','time']);
    return;
  }
  showPrivate(false);
}

document.getElementById('saveProfile').onclick = async ()=>{
  const msg = document.getElementById('nameMsg'); msg.textContent = 'Saving...';
  const body = {
    action:'upsertProfile',
    name: document.getElementById('name').value.trim() || 'Player',
    linkedin: document.getElementById('li').value.trim()
  };
  if (provider==='google' && idToken) body.idToken = idToken;
  if (provider==='email' && sessionToken) body.sessionToken = sessionToken;

  try{
    const r = await fetch(APPS+'?action=upsertProfile', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await r.json(); if (!j.ok) throw new Error(j.error||'Failed');
    msg.textContent = 'Saved ✔';
    await loadBoards();
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

document.getElementById('submitScore').onclick = async ()=>{
  const msg = document.getElementById('msg'); msg.textContent = 'Saving...';
  const body = {
    action:'submitScore',
    puzzle: +document.getElementById('pNum').value,
    time: document.getElementById('pTime').value.trim()
  };
  if (provider==='google' && idToken) body.idToken = idToken;
  if (provider==='email' && sessionToken) body.sessionToken = sessionToken;

  try{
    const r = await fetch(APPS+'?action=submitScore', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await r.json(); if (!j.ok) throw new Error(j.error||'Failed');
    msg.textContent = 'Saved ✔';
    await initMe(); await loadBoards();
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

document.getElementById('deleteMe').onclick = async ()=>{
  if (!confirm('Delete your profile and all scores? This cannot be undone.')) return;
  const msg = document.getElementById('msg'); msg.textContent = 'Deleting...';
  const body = { action:'deleteMe' };
  if (provider==='google' && idToken) body.idToken = idToken;
  if (provider==='email' && sessionToken) body.sessionToken = sessionToken;
  try{
    const r = await fetch(APPS+'?action=deleteMe', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await r.json(); if (!j.ok) throw new Error(j.error||'Failed');
    msg.textContent = 'Deleted ✔';
    localStorage.removeItem('zip_idtoken'); localStorage.removeItem('zip_session'); localStorage.removeItem('zip_provider');
    provider = idToken = sessionToken = null;
    showPrivate(false); loadBoards();
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

/* ---------- boot ---------- */
loadBoards();
if (provider) initMe();
</script>
</body>
</html>
