<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Zip Community Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-inline' https://accounts.google.com;
                 connect-src 'self' https://script.google.com https://script.googleusercontent.com https://oauth2.googleapis.com https://accounts.google.com;
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 frame-src https://accounts.google.com;">

  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{--card:#fff;--line:#eee;--muted:#666}
    body{font:16px system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;background:#fafafa}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
    .brand{font-size:32px;font-weight:800;line-height:1.15;}
    .btn{padding:8px 14px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    h2,h3{margin:8px 0 12px}
    small{color:var(--muted)}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row-between{display:flex;justify-content:space-between;align-items:center;gap:12px}
    select{padding:8px 10px;border:1px solid #ddd;border-radius:8px;background:#fff}
    input{padding:8px 10px;border:1px solid #ddd;border-radius:8px}
    .hide{display:none}
    .right{margin-left:auto}
    .toast{font-size:14px}
    .namecell a{font-size:12px;margin-left:6px;text-decoration:none}
    .footer{margin-top:28px;color:var(--muted)}
    .footer small{font-size:13px}
    .footer a{color:inherit;text-decoration:underline}
    .muted{color:var(--muted)}
    .consent{display:flex;align-items:center;gap:10px;margin-right:16px}
    .consent a{text-decoration:underline}

    /* stable widths / ellipsis */
    table{table-layout:fixed}
    :is(#today,#avg,#mine) th, :is(#today,#avg,#mine) td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    :is(#today,#avg,#mine) th:nth-child(1), :is(#today,#avg,#mine) td:nth-child(1){width:60px}
    :is(#today,#avg,#mine) th:nth-child(3), :is(#today,#avg,#mine) td:nth-child(3){width:80px}

    /* override for My best scores: make 3rd column 150px */
    #mine th:nth-child(3), #mine td:nth-child(3){width:150px}

    .namecell{display:flex;align-items:center;gap:6px;min-width:0}
    .namecell .nm{flex:1 1 auto;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .namecell a{flex:0 0 auto}

    /* no horizontal scroll */
    html,body{overflow-x:hidden}
    header>.row{flex:1 1 640px;min-width:0}
    @media (max-width:600px){
      .brand{font-size:26px}
      .consent{width:100%;margin-right:0}
      #authRow{width:100%;gap:8px}
      .g_id_signin{transform:scale(.88);transform-origin:left top}
      #authRow .btn{flex:0 0 auto}
    }

    /* section tints */
    .card--pl{background:#F5F0FF;border-color:#E6DDFF}
    .card--me{background:#EDF9F4;border-color:#D1F0E2}
    .card--me, .card--me ~ .card{background:#EDF9F4;border-color:#D1F0E2}

    /* hard-hide auth bits when signed in */
    body.signedin .consent,
    body.signedin .g_id_signin,
    body.signedin #useEmail{display:none !important;}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      Zip Community Leaderboard
      <div class="muted" style="font-size:14px;margin-top:2px;font-weight:normal;">
        <p style="margin:0">Unofficial, fan-created community leaderboard for the Zip puzzle.</p>
        <p style="margin:0">Not affiliated with or endorsed by LinkedIn.</p>
      </div>
    </div>

    <div class="row">
      <label class="consent" title="Required to use the service">
        <input type="checkbox" id="accept">
        <span>To log in, I agree to the <a href="terms.html" target="_blank" rel="noopener">Terms</a> and acknowledge the <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.</span>
      </label>

      <div id="authRow" class="row hide">
        <div id="g_id_onload"
          data-client_id="368132008439-lskm63n5dmsv9r43cchmrjpdmhfqaa1p.apps.googleusercontent.com"
          data-callback="onGoogle"
          data-auto_select="false"
          data-auto_prompt="false"
          data-itp_support="true"></div>
        <div class="g_id_signin" data-type="standard" data-size="medium"></div>

        <span class="btn" id="useEmail">Use email instead</span>
        <button class="btn hide" id="signOut">Sign out</button>
      </div>
    </div>
  </header>

  <div class="card card--pl">
    <h2>Public Leaderboards</h2>
    <small>Visible to everyone. Only <em>Name</em> + time are shown (with a LinkedIn link if you added one).</small>
  </div>

  <div class="grid">
    <div class="card card--pl">
      <div class="row-between">
        <h3 id="todayTitle">Puzzle #</h3>
        <div class="row">
          <select id="puzzleSel" title="Choose a day/puzzle"></select>
          <button class="btn" id="refresh" title="Reload data">Reload</button>
        </div>
      </div>
      <table id="today"><thead><tr><th>#</th><th>Player</th><th>Time</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card card--pl">
      <h3>Average time (per person)</h3>
      <table id="avg"><thead><tr><th>#</th><th>Player</th><th>Avg Time</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card card--me">
    <h2>My private profile</h2>
    <small>Only you can see and edit this after signing in.</small>

    <div id="emailBox" class="hide" style="margin:12px 0 4px">
      <div class="row">
        <label>Email <input id="eml" placeholder="you@example.com"></label>
        <button class="btn" id="sendCode">Get code</button>
        <label>Code <input id="otp" placeholder="6-digit"></label>
        <button class="btn" id="verifyCode">Verify</button>
        <span class="toast" id="otpMsg"></span>
      </div>
      <small class="muted">We’ll send a one-time code only to sign you in. No marketing. The code expires in 10 minutes.</small>
      <div style="height:1px;background:#eee;margin:12px 0"></div>
    </div>

    <div id="private" class="hide">
      <div class="row" style="margin-top:10px">
        <label>Name
          <input id="name" maxlength="80" placeholder="Shown on leaderboards">
        </label>
        <label>LinkedIn URL (optional)
          <input id="li" maxlength="200" placeholder="https://www.linkedin.com/in/…">
        </label>
        <button class="btn" id="saveProfile">Save</button>
        <span class="toast" id="nameMsg"></span>
        <button class="btn right" id="deleteMe" title="Delete profile & all scores">Delete my data</button>
      </div>

      <div class="row" style="margin-top:10px">
        <label>Puzzle # <input id="pNum" type="number" min="1" placeholder="e.g., 193"></label>
        <label>Time (mm:ss) <input id="pTime" placeholder="0:08" pattern="\\d{1,2}:[0-5]\\d"></label>
        <button class="btn" id="submitScore">Submit</button>
        <span class="toast" id="msg"></span>
      </div>

      <h3 style="margin-top:16px">My best scores</h3>
      <table id="mine">
        <thead>
          <tr><th>#</th><th>Puzzle</th><th>Date</th><th>Time</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="pleaseSignIn">
      <small>Sign in above to manage your private profile and submit scores.</small>
      <div class="muted" style="margin-top:6px">
        <small>
          By signing in you agree to our
          <a href="terms.html" target="_blank" rel="noopener">Terms</a> and
          <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.
        </small>
      </div>
    </div>
  </div>

<script>
const APPS = 'https://script.google.com/macros/s/AKfycbxNN6VLQeEkC0oA6AXbx1jO9XWPT-NBv99_UEvzdkGrSAbHwizBm-j7WVhlTWI1w8gy/exec';

let provider = localStorage.getItem('zip_provider') || null;
let idToken = localStorage.getItem('zip_idtoken') || null;
let sessionToken = localStorage.getItem('zip_session') || null;

/* consent gate */
function isAccepted(){ return localStorage.getItem('zip_accept') === '1'; }
function setGate(on){
  document.getElementById('authRow').classList.toggle('hide', !on);
}
(function initConsent(){
  const box = document.getElementById('accept');
  const accepted = isAccepted();
  box.checked = accepted;
  setGate(accepted);
  box.addEventListener('change', (e)=>{
    const ok = !!e.target.checked;
    localStorage.setItem('zip_accept', ok ? '1' : '0');
    setGate(ok);
    if (provider) setSignedInUI(true);
  });
})();

/* helpers */
function onlyMMSS(t){
  const m = (t||'').match(/\b\d{1,3}:[0-5]\d\b/);
  return m ? m[0] : (t||'');
}
function fmtMMSS(sec){             /* from seconds -> m:ss */
  if (sec == null || isNaN(sec)) return '';
  const s = Math.round(sec);
  const m = Math.floor(s/60), r = s % 60;
  return `${m}:${String(r).padStart(2,'0')}`;
}

/* map puzzle -> label from dropdown (e.g., "2025-09-27 — #194") */
let PUZZLE_LABELS = {};  // puzzle -> label text

/* UI helpers */
function showPrivate(on){
  document.getElementById('private').classList.toggle('hide', !on);
  document.getElementById('pleaseSignIn').classList.toggle('hide', on);
  document.getElementById('signOut').classList.toggle('hide', !on);
}
function setSignedInUI(loggedIn){
  document.body.classList.toggle('signedin', loggedIn);
  const authRow = document.getElementById('authRow');
  if (authRow) authRow.classList.toggle('hide', !isAccepted() && !loggedIn);
}
function linkHtml(url){ return url ? `<a href="${url}" target="_blank" rel="noopener" title="LinkedIn">↗</a>` : ''; }

/* RENDER: prefer numeric seconds for public boards to avoid 1899/offset issues */
function renderRows(id, rows){
  const tb = document.querySelector('#'+id+' tbody'); tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr');
    let timeText = '';
    if (id==='today'){
      timeText = (typeof r.seconds === 'number')
        ? fmtMMSS(r.seconds)
        : (typeof r.ms === 'number')
          ? fmtMMSS(r.ms/1000)
          : onlyMMSS(r.time || r.result || '');
    }else if (id==='avg'){
      timeText = (typeof r.avgSeconds === 'number')
        ? fmtMMSS(r.avgSeconds)
        : (typeof r.seconds === 'number')
          ? fmtMMSS(r.seconds)
          : onlyMMSS(r.avg || r.time || '');
    }else{
      timeText = r.time || '';
    }
    tr.innerHTML = `<td>${i+1}</td><td class="namecell"><span class="nm">${r.player || ''}</span>${linkHtml(r.linkedin)}</td><td>${timeText}</td>`;
    tb.appendChild(tr);
  });
}

function setTodayTitle(_puzzle, label){
  document.getElementById('todayTitle').textContent = label || 'Puzzle #';
}

/* puzzles dropdown */
function populatePuzzles(list, latest){
  const sel = document.getElementById('puzzleSel');
  sel.innerHTML = '';
  PUZZLE_LABELS = {};
  (list||[]).sort((a,b)=> b.puzzle - a.puzzle).forEach(it=>{
    const opt = document.createElement('option');
    opt.value = it.puzzle;
    const label = `${it.date} — #${it.puzzle}`;
    opt.textContent = label;
    PUZZLE_LABELS[String(it.puzzle)] = label;    // map for My best scores
    if (String(it.puzzle) === String(latest)) opt.selected = true;
    sel.appendChild(opt);
  });
  const label = sel.selectedOptions[0] ? sel.selectedOptions[0].textContent : ('Puzzle #'+(latest||''));
  setTodayTitle(sel.value || latest, label);
}

/* Public boards */
async function loadBoards(puzzle){
  try{
    const q = puzzle ? ('&puzzle='+encodeURIComponent(puzzle)) : '';
    const r = await fetch(APPS+'?action=leaderboard'+q);
    const j = await r.json();
    if (j.puzzles) populatePuzzles(j.puzzles, puzzle || j.latestPuzzle);
    renderRows('today', j.today||[]);
    renderRows('avg',   j.averages||[]);
    if (j.latestPuzzle && !document.getElementById('pNum').value) {
      document.getElementById('pNum').value = j.latestPuzzle;
    }
  }catch(e){ console.error(e); }
}
document.getElementById('puzzleSel').addEventListener('change', (e)=>{
  const opt = e.target.selectedOptions[0];
  setTodayTitle(e.target.value, opt ? opt.textContent : '');
  loadBoards(e.target.value);
});
document.getElementById('refresh').onclick = ()=>{
  const v = document.getElementById('puzzleSel').value;
  loadBoards(v);
};

/* Auth */
document.getElementById('useEmail').onclick = ()=>{
  if (!isAccepted()){ alert('Please accept the Terms and Privacy Policy first.'); return; }
  document.getElementById('emailBox').classList.remove('hide');
};

document.getElementById('signOut').onclick = async ()=>{
  try{
    if (provider==='email' && sessionToken){
      await fetch(APPS+'?action=logout', {
        method:'POST',
        body: JSON.stringify({action:'logout', sessionToken})
      });
    }
  }catch(_){}
  localStorage.removeItem('zip_idtoken'); localStorage.removeItem('zip_session'); localStorage.removeItem('zip_provider');
  provider = idToken = sessionToken = null;
  showPrivate(false);
  setSignedInUI(false);
  setGate(isAccepted());
};

window.onGoogle = (resp) => {
  if (!isAccepted()){ alert('Please accept the Terms and Privacy Policy first.'); return; }
  idToken = resp.credential;
  provider = 'google';
  localStorage.setItem('zip_idtoken', idToken);
  localStorage.setItem('zip_provider', provider);
  initMe();
};

/* Email OTP */
document.getElementById('sendCode').onclick = async ()=>{
  if (!isAccepted()){ alert('Please accept the Terms and Privacy Policy first.'); return; }
  const email = document.getElementById('eml').value.trim();
  const msg = document.getElementById('otpMsg'); msg.textContent = 'Sending...';
  try{
    const r = await fetch(APPS+'?action=requestOtp', {
      method:'POST',
      body: JSON.stringify({action:'requestOtp', email})
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Failed');
    msg.textContent = 'Code sent. Check your inbox (valid 10 min).';
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

document.getElementById('verifyCode').onclick = async ()=>{
  if (!isAccepted()){ alert('Please accept the Terms and Privacy Policy first.'); return; }
  const email = document.getElementById('eml').value.trim();
  const code = document.getElementById('otp').value.trim();
  const msg = document.getElementById('otpMsg'); msg.textContent = 'Verifying...';
  try{
    const r = await fetch(APPS+'?action=verifyOtp', {
      method:'POST',
      body: JSON.stringify({action:'verifyOtp', email, code})
    });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Failed');
    sessionToken = j.sessionToken; provider='email';
    localStorage.setItem('zip_session', sessionToken);
    localStorage.setItem('zip_provider', provider);
    msg.textContent = 'Signed in ✔';
    initMe();
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

/* Private actions */
document.getElementById('saveProfile').onclick = async ()=>{
  const msg = document.getElementById('nameMsg'); msg.textContent = 'Saving...';
  const body = {
    action:'upsertProfile',
    name: document.getElementById('name').value.trim() || 'Player',
    linkedin: document.getElementById('li').value.trim()
  };
  if (provider==='google' && idToken) body.idToken = idToken;
  if (provider==='email' && sessionToken) body.sessionToken = sessionToken;
  try{
    const r = await fetch(APPS+'?action=upsertProfile', {
      method:'POST',
      body: JSON.stringify(body)
    });
    const j = await r.json(); if (!j.ok) throw new Error(j.error||'Failed');
    msg.textContent = 'Saved ✔';
    await loadBoards(document.getElementById('puzzleSel').value);
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

document.getElementById('submitScore').onclick = async ()=>{
  const msg = document.getElementById('msg'); msg.textContent = 'Saving...';
  const body = {
    action:'submitScore',
    puzzle: +document.getElementById('pNum').value,
    time: document.getElementById('pTime').value.trim()
  };
  if (provider==='google' && idToken) body.idToken = idToken;
  if (provider==='email' && sessionToken) body.sessionToken = sessionToken;
  try{
    const r = await fetch(APPS+'?action=submitScore', {
      method:'POST',
      body: JSON.stringify(body)
    });
    const j = await r.json(); if (!j.ok) throw new Error(j.error||'Failed');
    msg.textContent = 'Saved ✔';
    await initMe();
    await loadBoards(document.getElementById('puzzleSel').value);
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

document.getElementById('deleteMe').onclick = async ()=>{
  if (!confirm('Delete your profile and all scores? This cannot be undone.')) return;
  const msg = document.getElementById('msg'); msg.textContent = 'Deleting...';
  const body = { action:'deleteMe' };
  if (provider==='google' && idToken) body.idToken = idToken;
  if (provider==='email' && sessionToken) body.sessionToken = sessionToken;
  try{
    const r = await fetch(APPS+'?action=deleteMe', {
      method:'POST',
      body: JSON.stringify(body)
    });
    const j = await r.json(); if (!j.ok) throw new Error(j.error||'Failed');
    msg.textContent = 'Deleted ✔';
    localStorage.removeItem('zip_idtoken'); localStorage.removeItem('zip_session'); localStorage.removeItem('zip_provider');
    provider = idToken = sessionToken = null;
    showPrivate(false);
    setSignedInUI(false);
    setGate(isAccepted());
    loadBoards(document.getElementById('puzzleSel').value);
  }catch(e){ msg.textContent = 'Error: '+e.message; }
};

/* delete a single score (per-row) */
async function deleteOneScore(payload){
  const body = { action:'deleteScore', ...payload };
  if (provider==='google' && idToken) body.idToken = idToken;
  if (provider==='email' && sessionToken) body.sessionToken = sessionToken;
  try{
    const r = await fetch(APPS+'?action=deleteScore', { method:'POST', body: JSON.stringify(body) });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error||'Failed');
    await initMe();
    await loadBoards(document.getElementById('puzzleSel').value);
  }catch(e){
    const msg = document.getElementById('msg'); msg.textContent = 'Error: '+e.message;
  }
}

/* Private area */
async function initMe(){
  if (provider==='google' && idToken){
    const r = await fetch(APPS+'?action=me&idToken='+encodeURIComponent(idToken));
    const j = await r.json();
    if (j.error){ showPrivate(false); setSignedInUI(false); return; }
    showPrivate(true); setSignedInUI(true);
    document.getElementById('name').value = (j.profile && j.profile.name) || 'Player';
    document.getElementById('li').value = (j.profile && j.profile.linkedin) || '';
    const mine = (j.scores||[]).sort((a,b)=>a.seconds-b.seconds);
    const tb = document.querySelector('#mine tbody'); tb.innerHTML='';
    mine.forEach((r,i)=>{
      const id = r.id || null;
      const dateLabel = PUZZLE_LABELS[String(r.puzzle)] || (`#${r.puzzle}`);
      const timeTxt = (typeof r.seconds === 'number') ? fmtMMSS(r.seconds) : onlyMMSS(r.time || '');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.puzzle}</td><td>${dateLabel}</td><td>${timeTxt}</td><td><button class="btn delScore" data-id="${id||''}" data-puzzle="${r.puzzle}" data-time="${r.time||''}">Delete</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('.delScore').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        if (!confirm('Delete this score?')) return;
        const el = e.currentTarget;
        const id = el.getAttribute('data-id');
        const puzzle = +el.getAttribute('data-puzzle');
        const timeTxt = el.getAttribute('data-time');
        deleteOneScore(id ? {id} : {puzzle, time: timeTxt});
      });
    });
    return;
  }
  if (provider==='email' && sessionToken){
    const r = await fetch(APPS+'?action=me&sessionToken='+encodeURIComponent(sessionToken));
    const j = await r.json();
    if (j.error){ showPrivate(false); setSignedInUI(false); return; }
    showPrivate(true); setSignedInUI(true);
    document.getElementById('name').value = (j.profile && j.profile.name) || 'Player';
    document.getElementById('li').value = (j.profile && j.profile.linkedin) || '';
    const mine = (j.scores||[]).sort((a,b)=>a.seconds-b.seconds);
    const tb = document.querySelector('#mine tbody'); tb.innerHTML='';
    mine.forEach((r,i)=>{
      const id = r.id || null;
      const dateLabel = PUZZLE_LABELS[String(r.puzzle)] || (`#${r.puzzle}`);
      const timeTxt = (typeof r.seconds === 'number') ? fmtMMSS(r.seconds) : onlyMMSS(r.time || '');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.puzzle}</td><td>${dateLabel}</td><td>${timeTxt}</td><td><button class="btn delScore" data-id="${id||''}" data-puzzle="${r.puzzle}" data-time="${r.time||''}">Delete</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('.delScore').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        if (!confirm('Delete this score?')) return;
        const el = e.currentTarget;
        const id = el.getAttribute('data-id');
        const puzzle = +el.getAttribute('data-puzzle');
        const timeTxt = el.getAttribute('data-time');
        deleteOneScore(id ? {id} : {puzzle, time: timeTxt});
      });
    });
    return;
  }
  showPrivate(false); setSignedInUI(false);
}

/* boot */
loadBoards();
if (provider) initMe();
</script>

<footer class="footer">
  <p class="muted" style="margin-top:8px">
    “Zip” and “LinkedIn” are trademarks of LinkedIn Corporation. This is an independent community project and is not affiliated with, endorsed by, or sponsored by LinkedIn.
  </p>
</footer>
</body>
</html>
